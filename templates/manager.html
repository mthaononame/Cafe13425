{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold"><i class="fas fa-cogs"></i> QU·∫¢N TR·ªä VI√äN</h2>
        <button class="btn btn-warning fw-bold text-dark shadow-sm" data-bs-toggle="modal" data-bs-target="#reportModal">
            <i class="fas fa-chart-line"></i> B√ÅO C√ÅO DOANH THU
        </button>
    </div>

    <ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'products' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-products">üì¶ S·∫£n ph·∫©m</button></li>
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'employees' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-employees">üë• Nh√¢n vi√™n</button></li>
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'discounts' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-discounts">üéüÔ∏è M√£ gi·∫£m gi√°</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-bills">üìú L·ªãch s·ª≠ H√≥a ƒë∆°n</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade {{ 'show active' if active_tab == 'products' else '' }}" id="tab-products">
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow mb-3 border-0">
                        <div class="card-header bg-success text-white fw-bold"><i class="fas fa-plus-circle"></i> TH√äM M√ìN M·ªöI</div>
                        <div class="card-body">
                            <form method="POST" enctype="multipart/form-data">
                                <input type="hidden" name="save_product" value="1">
                                <div class="mb-2"><label class="fw-bold">T√™n m√≥n:</label><input type="text" name="name" class="form-control" required placeholder="VD: Tr√† ƒê√†o"></div>
                                <div class="mb-2"><label class="fw-bold">Danh m·ª•c:</label><select name="category" class="form-select"><option value="Cafe">Cafe</option><option value="Tr√†">Tr√† / Tr√† S·ªØa</option><option value="B√°nh">B√°nh Ng·ªçt</option><option value="Kh√°c">Kh√°c</option></select></div>
                                <div class="row"><div class="col-6 mb-2"><label class="fw-bold">Gi√°:</label><input type="number" name="price" class="form-control" required></div><div class="col-6 mb-2"><label class="fw-bold">Kho:</label><input type="number" name="stock" class="form-control" value="100"></div></div>
                                <div class="mb-2 form-check bg-light p-2 rounded"><input type="checkbox" class="form-check-input" name="is_active" checked><label class="form-check-label fw-bold text-success">ƒêang kinh doanh</label></div>
                                <div class="mb-3"><label class="fw-bold">·∫¢nh:</label><input type="text" name="image_url" class="form-control mb-1" placeholder="Link ·∫£nh..."><input type="file" name="image_file" class="form-control"></div>
                                <button type="submit" class="btn btn-success w-100 fw-bold shadow-sm"><i class="fas fa-save"></i> TH√äM NGAY</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow border-0">
                        <div class="card-body p-0 table-responsive" style="max-height: 600px;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top"><tr><th>·∫¢nh</th><th>T√™n</th><th>Gi√°</th><th>Kho</th><th>H√†nh ƒë·ªông</th></tr></thead>
                                <tbody>
                                    {% for p in products %}
                                    <tr class="{{ 'table-secondary' if not p.is_active }}">
                                        <td><img src="{{ p.image }}" width="50" height="50" class="rounded shadow-sm" style="object-fit: cover;" onerror="this.src='https://via.placeholder.com/50'"></td>
                                        <td class="fw-bold">{{ p.name }}</td>
                                        <td class="text-danger fw-bold">{{ "{:,.0f}".format(p.price) }}</td>
                                        <td>{{ p.inventory.stock_quantity }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary edit-btn shadow-sm" 
                                                data-id="{{ p.id }}" data-name="{{ p.name }}" 
                                                data-price="{{ p.price }}" data-stock="{{ p.inventory.stock_quantity }}" 
                                                data-cat="{{ p.category }}" data-img="{{ p.image }}" 
                                                data-active="{{ 'true' if p.is_active else 'false' }}">
                                                <i class="fas fa-pen"></i> S·ª≠a
                                            </button>
                                            
                                            <button class="btn btn-sm btn-outline-danger delete-btn shadow-sm" 
                                                data-id="{{ p.id }}" data-name="{{ p.name }}">
                                                <i class="fas fa-trash"></i> X√≥a
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'employees' else '' }}" id="tab-employees">
            <div class="row"><div class="col-md-4"><div class="card shadow mb-3 border-0"><div class="card-header bg-info text-white fw-bold" id="emp-header"><i class="fas fa-user-plus"></i> Th√™m Nh√¢n Vi√™n</div><div class="card-body"><form method="POST" id="emp-form"><input type="hidden" name="save_employee" value="1"><input type="hidden" name="user_id" id="emp-id"><div class="mb-2"><label class="fw-bold">T√™n ƒëƒÉng nh·∫≠p:</label><input type="text" name="username" id="emp-user" class="form-control" required></div><div class="mb-2"><label class="fw-bold">M·∫≠t kh·∫©u:</label><input type="password" name="password" id="emp-pass" class="form-control" required placeholder="B·∫Øt bu·ªôc nh·∫≠p khi t·∫°o m·ªõi"></div><div class="mb-3"><label class="fw-bold">H·ªç v√† T√™n:</label><input type="text" name="fullname" id="emp-name" class="form-control" required></div><button type="submit" class="btn btn-info w-100 text-white fw-bold" id="emp-save">L∆ØU NH√ÇN VI√äN</button><button type="button" class="btn btn-secondary w-100 mt-2" onclick="resetEmpForm()" id="emp-cancel" style="display:none;">H·ªßy S·ª≠a / Th√™m M·ªõi</button></form></div></div></div><div class="col-md-8"><div class="card shadow border-0"><div class="card-body p-0"><table class="table table-bordered mb-0"><thead class="table-light"><tr><th>Username</th><th>H·ªç t√™n</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>{% for e in employees %}<tr><td>{{ e.username }}</td><td>{{ e.full_name }}</td><td><button class="btn btn-sm btn-primary edit-emp-btn" data-id="{{ e.id }}" data-user="{{ e.username }}" data-name="{{ e.full_name }}"><i class="fas fa-edit"></i></button><form method="POST" class="d-inline" onsubmit="return confirm('X√≥a nh√¢n vi√™n n√†y?');"><input type="hidden" name="delete_employee" value="1"><input type="hidden" name="user_id" value="{{ e.id }}"><button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></form></td></tr>{% endfor %}</tbody></table></div></div></div></div>
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'discounts' else '' }}" id="tab-discounts">
             <div class="row"><div class="col-md-4"><div class="card shadow"><div class="card-body"><form method="POST"><input type="hidden" name="add_discount" value="1"><div class="mb-2"><input type="text" name="code" class="form-control" placeholder="M√£ (VD: SALE50)" required></div><div class="mb-3"><input type="number" name="percent" class="form-control" placeholder="% Gi·∫£m" required></div><button class="btn btn-warning w-100 fw-bold">Th√™m</button></form></div></div></div><div class="col-md-8"><table class="table bg-white"><thead><tr><th>Code</th><th>%</th></tr></thead><tbody>{% for d in discounts %}<tr><td>{{ d.code }}</td><td>{{ d.percentage }}%</td></tr>{% endfor %}</tbody></table></div></div>
        </div>

        <div class="tab-pane fade" id="tab-bills">
             <div class="card shadow border-0"><div class="card-header bg-dark text-white fw-bold"><i class="fas fa-history"></i> L·ªãch S·ª≠ Giao D·ªãch</div><div class="card-body p-0 table-responsive" style="max-height: 600px;"><table class="table table-striped table-hover mb-0 align-middle"><thead class="table-light"><tr><th>M√£ Hƒê</th><th>Th·ªùi gian</th><th>Kh√°ch h√†ng</th><th>Thu ng√¢n</th><th>Chi ti·∫øt</th><th>Gi·∫£m gi√°</th><th>Th·ª±c thu</th></tr></thead><tbody>{% for bill in all_bills %}<tr><td>#{{ bill.id }}</td><td>{{ bill.created_at.strftime("%d/%m/%Y %H:%M") }}</td><td>{{ bill.order.customer.full_name if bill.order.customer else 'Kh√°ch v√£ng lai' }}</td><td>{{ bill.order.staff.full_name if bill.order.staff else 'T·ª± ƒë·ªông' }}</td><td><small>{{ bill.order.details_str }}</small></td><td class="text-success">{{ "-{:,.0f}".format(bill.discount_applied) }}</td><td class="fw-bold text-danger">{{ "{:,.0f}".format(bill.final_amount) }}</td></tr>{% endfor %}</tbody></table></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-edit"></i> C·∫¨P NH·∫¨T S·∫¢N PH·∫®M</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="edit-form">
                    <input type="hidden" name="save_product" value="1">
                    <input type="hidden" name="product_id" id="edit-pid"> <div class="mb-2"><label class="fw-bold">T√™n m√≥n:</label><input type="text" name="name" id="edit-name" class="form-control" required></div>
                    <div class="mb-2"><label class="fw-bold">Danh m·ª•c:</label><select name="category" id="edit-cat" class="form-select"><option value="Cafe">Cafe</option><option value="Tr√†">Tr√† / Tr√† S·ªØa</option><option value="B√°nh">B√°nh Ng·ªçt</option><option value="Kh√°c">Kh√°c</option></select></div>
                    <div class="row">
                        <div class="col-6 mb-2"><label class="fw-bold">Gi√° b√°n:</label><input type="number" name="price" id="edit-price" class="form-control" required></div>
                        <div class="col-6 mb-2"><label class="fw-bold">T·ªìn kho:</label><input type="number" name="stock" id="edit-stock" class="form-control" required></div>
                    </div>
                    
                    <div class="mb-3 p-2 bg-light rounded border">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_active" id="edit-active">
                            <label class="form-check-label fw-bold text-primary" for="edit-active">ƒêang kinh doanh (B·∫≠t/T·∫Øt)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">C·∫≠p nh·∫≠t ·∫¢nh (Kh√¥ng b·∫Øt bu·ªôc):</label>
                        <input type="text" name="image_url" id="edit-img-url" class="form-control mb-1" placeholder="Link ·∫£nh m·ªõi...">
                        <input type="file" name="image_file" class="form-control">
                        <small class="text-muted">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën gi·ªØ ·∫£nh c≈©.</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary fw-bold py-2"><i class="fas fa-save"></i> L∆ØU THAY ƒê·ªîI</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white justify-content-center">
                <h5 class="modal-title fw-bold">‚ö†Ô∏è X√ìA S·∫¢N PH·∫®M</h5>
            </div>
            <div class="modal-body text-center p-4">
                <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n <b id="del-name" class="text-danger"></b> kh√¥ng?</p>
                <p class="small text-muted">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                
                <form method="POST">
                    <input type="hidden" name="delete_product" value="1">
                    <input type="hidden" name="product_id" id="del-id">
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-danger fw-bold">X√≥a Ngay</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title fw-bold"><i class="fas fa-chart-pie"></i> T·ªîNG QUAN DOANH THU</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><div class="row mb-4 text-center"><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-success text-white rounded"><h6 class="text-uppercase small">H√¥m nay</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_day) }} ƒë</h3></div></div></div><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-primary text-white rounded"><h6 class="text-uppercase small">Tu·∫ßn n√†y</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_week) }} ƒë</h3></div></div></div><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-danger text-white rounded"><h6 class="text-uppercase small">Th√°ng n√†y</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_month) }} ƒë</h3></div></div></div></div><hr><h6 class="fw-bold mb-3"><i class="fas fa-filter"></i> Tra c·ª©u chi ti·∫øt:</h6><form method="POST"><input type="hidden" name="filter_report" value="1"><div class="row"><div class="col-md-4 mb-3"><select class="form-select" id="filterType" name="filter_type" onchange="toggleDateInput()"><option value="day">Theo Ng√†y</option><option value="month">Theo Th√°ng</option><option value="year">Theo NƒÉm</option></select></div><div class="col-md-5 mb-3"><input type="date" class="form-control" name="date_val" id="dateInput" required></div><div class="col-md-3"><button class="btn btn-dark w-100 fw-bold">Tra c·ª©u</button></div></div></form>{% if report_title %}<div class="alert alert-info text-center mt-3 mb-0">K·∫øt qu·∫£ <b>{{ report_title }}</b>: <span class="fw-bold fs-4 text-danger">{{ "{:,.0f}".format(filtered_revenue) }} ƒë</span></div>{% endif %}</div></div></div></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // KH·ªûI T·∫†O MODAL
        var editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteProductModal'));

        // --- X·ª¨ L√ù N√öT S·ª¨A S·∫¢N PH·∫®M ---
        const editBtns = document.querySelectorAll('.edit-btn');
        editBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                // ƒêi·ªÅn d·ªØ li·ªáu v√†o Modal S·ª≠a
                document.getElementById('edit-pid').value = data.id;
                document.getElementById('edit-name').value = data.name;
                document.getElementById('edit-price').value = data.price;
                document.getElementById('edit-stock').value = data.stock;
                document.getElementById('edit-cat').value = data.cat;
                
                if(!data.img.startsWith('/static')) {
                    document.getElementById('edit-img-url').value = data.img;
                } else {
                    document.getElementById('edit-img-url').value = "";
                }
                
                document.getElementById('edit-active').checked = (data.active === 'true');
                
                // M·ªü Modal
                editModal.show();
            });
        });

        // --- X·ª¨ L√ù N√öT X√ìA S·∫¢N PH·∫®M ---
        const deleteBtns = document.querySelectorAll('.delete-btn');
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                document.getElementById('del-id').value = data.id;
                document.getElementById('del-name').innerText = data.name;
                deleteModal.show();
            });
        });

        // --- X·ª¨ L√ù S·ª¨A NH√ÇN VI√äN (Gi·ªØ nguy√™n Logic c≈©) ---
        const editEmpBtns = document.querySelectorAll('.edit-emp-btn');
        editEmpBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                document.getElementById('emp-id').value = data.id;
                document.getElementById('emp-user').value = data.user;
                document.getElementById('emp-user').readOnly = true; 
                document.getElementById('emp-name').value = data.name;
                
                const passField = document.getElementById('emp-pass');
                passField.placeholder = "ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi"; passField.required = false;

                const header = document.getElementById('emp-header');
                const btnSave = document.getElementById('emp-save');
                header.innerHTML = '<i class="fas fa-user-edit"></i> C·∫≠p Nh·∫≠t Nh√¢n Vi√™n';
                header.className = 'card-header bg-warning text-dark fw-bold';
                btnSave.innerHTML = 'L∆ØU THAY ƒê·ªîI';
                btnSave.className = 'btn btn-warning w-100 fw-bold';
                document.getElementById('emp-cancel').style.display = 'block';
            });
        });
    });

    function resetEmpForm() {
        document.getElementById('emp-id').value = ""; document.getElementById('emp-form').reset();
        document.getElementById('emp-user').readOnly = false;
        document.getElementById('emp-pass').placeholder = "B·∫Øt bu·ªôc nh·∫≠p"; document.getElementById('emp-pass').required = true;
        const header = document.getElementById('emp-header'); const btnSave = document.getElementById('emp-save');
        header.innerHTML = '<i class="fas fa-user-plus"></i> Th√™m Nh√¢n Vi√™n'; header.className = 'card-header bg-info text-white fw-bold';
        btnSave.innerHTML = 'L∆ØU NH√ÇN VI√äN'; btnSave.className = 'btn btn-info w-100 text-white fw-bold';
        document.getElementById('emp-cancel').style.display = 'none';
    }

    function toggleDateInput() {
        let type = document.getElementById('filterType').value;
        let input = document.getElementById('dateInput');
        if(type === 'day') input.type = 'date';
        else if(type === 'month') input.type = 'month';
        else if(type === 'year') { input.type = 'number'; input.placeholder="2026"; }
    }
</script>
{% endblock %}
