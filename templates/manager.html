{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold"><i class="fas fa-cogs"></i> QU·∫¢N TR·ªä VI√äN</h2>
        <button class="btn btn-warning fw-bold text-dark shadow-sm" data-bs-toggle="modal" data-bs-target="#reportModal">
            <i class="fas fa-chart-line"></i> B√ÅO C√ÅO DOANH THU
        </button>
    </div>

    <ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'products' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-products">üì¶ S·∫£n ph·∫©m</button></li>
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'employees' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-employees">üë• Nh√¢n vi√™n</button></li>
        <li class="nav-item"><button class="nav-link fw-bold {{ 'active' if active_tab == 'discounts' else '' }}" data-bs-toggle="tab" data-bs-target="#tab-discounts">üéüÔ∏è M√£ gi·∫£m gi√°</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#tab-bills">üìú L·ªãch s·ª≠ H√≥a ƒë∆°n</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade {{ 'show active' if active_tab == 'products' else '' }}" id="tab-products">
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow mb-3 border-0">
                        <div class="card-header bg-success text-white fw-bold" id="form-header"><i class="fas fa-plus-circle"></i> Th√™m M√≥n M·ªõi</div>
                        <div class="card-body">
                            <form method="POST" enctype="multipart/form-data" id="product-form">
                                <input type="hidden" name="save_product" value="1"><input type="hidden" name="product_id" id="inp-pid">
                                <div class="mb-2"><label class="fw-bold">T√™n m√≥n:</label><input type="text" name="name" id="inp-name" class="form-control" required></div>
                                <div class="mb-2"><label class="fw-bold">Danh m·ª•c:</label><select name="category" id="inp-cat" class="form-select"><option value="Cafe">Cafe</option><option value="Tr√†">Tr√† / Tr√† S·ªØa</option><option value="B√°nh">B√°nh Ng·ªçt</option><option value="Kh√°c">Kh√°c</option></select></div>
                                <div class="row"><div class="col-6 mb-2"><label class="fw-bold">Gi√°:</label><input type="number" name="price" id="inp-price" class="form-control" required></div><div class="col-6 mb-2"><label class="fw-bold">Kho:</label><input type="number" name="stock" id="inp-stock" class="form-control" value="100"></div></div>
                                <div class="mb-2 form-check bg-light p-2 rounded"><input type="checkbox" class="form-check-input" name="is_active" id="inp-active" checked><label class="form-check-label fw-bold text-success">ƒêang kinh doanh</label></div>
                                <div class="mb-3"><label class="fw-bold">·∫¢nh:</label><div class="nav nav-tabs mb-2" id="imgTab"><button class="nav-link active py-1" data-bs-toggle="tab" data-bs-target="#tab-file" type="button">Upload</button><button class="nav-link py-1" data-bs-toggle="tab" data-bs-target="#tab-link" type="button">Link</button></div><div class="tab-content"><div class="tab-pane fade show active" id="tab-file"><input type="file" name="image_file" class="form-control" accept="image/*"></div><div class="tab-pane fade" id="tab-link"><input type="text" name="image_url" id="inp-img" class="form-control" placeholder="https://..."></div></div></div>
                                <button type="submit" class="btn btn-success w-100 fw-bold shadow-sm" id="btn-save"><i class="fas fa-save"></i> L∆ØU M√ìN</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="resetForm()" id="btn-cancel" style="display:none;">H·ªßy S·ª≠a</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card shadow border-0">
                        <div class="card-body p-0 table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top"><tr><th>·∫¢nh</th><th>T√™n</th><th>Gi√°</th><th>TT</th><th>X·ª≠ l√Ω</th></tr></thead>
                                <tbody>
                                    {% for p in products %}
                                    <tr class="{{ 'table-secondary' if not p.is_active }}">
                                        <td><img src="{{ p.image }}" width="50" height="50" class="rounded shadow-sm" style="object-fit: cover;" onerror="this.src='https://via.placeholder.com/50'"></td>
                                        <td class="fw-bold">{{ p.name }}</td><td class="text-danger fw-bold">{{ "{:,.0f}".format(p.price) }}</td>
                                        <td>{% if p.is_active %}<span class="badge bg-success">B√°n</span>{% else %}<span class="badge bg-secondary">Ng·ª´ng</span>{% endif %}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary edit-btn" data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.price }}" data-stock="{{ p.inventory.stock_quantity }}" data-cat="{{ p.category }}" data-img="{{ p.image }}" data-active="{{ 'true' if p.is_active else 'false' }}"><i class="fas fa-edit"></i></button>
                                            <form method="POST" class="d-inline" onsubmit="return confirm('X√≥a vƒ©nh vi·ªÖn?');"><input type="hidden" name="delete_product" value="1"><input type="hidden" name="product_id" value="{{ p.id }}"><button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'employees' else '' }}" id="tab-employees">
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow mb-3 border-0">
                        <div class="card-header bg-info text-white fw-bold" id="emp-header"><i class="fas fa-user-plus"></i> Th√™m Nh√¢n Vi√™n</div>
                        <div class="card-body">
                            <form method="POST" id="emp-form">
                                <input type="hidden" name="save_employee" value="1"><input type="hidden" name="user_id" id="emp-id">
                                <div class="mb-2"><label class="fw-bold">T√™n ƒëƒÉng nh·∫≠p:</label><input type="text" name="username" id="emp-user" class="form-control" required></div>
                                <div class="mb-2"><label class="fw-bold">M·∫≠t kh·∫©u:</label><input type="password" name="password" id="emp-pass" class="form-control" required placeholder="B·∫Øt bu·ªôc nh·∫≠p khi t·∫°o m·ªõi"></div>
                                <div class="mb-3"><label class="fw-bold">H·ªç v√† T√™n:</label><input type="text" name="fullname" id="emp-name" class="form-control" required></div>
                                <button type="submit" class="btn btn-info w-100 text-white fw-bold" id="emp-save">L∆ØU NH√ÇN VI√äN</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="resetEmpForm()" id="emp-cancel" style="display:none;">H·ªßy S·ª≠a</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card shadow border-0">
                        <div class="card-body p-0">
                            <table class="table table-bordered mb-0">
                                <thead class="table-light"><tr><th>Username</th><th>H·ªç t√™n</th><th>H√†nh ƒë·ªông</th></tr></thead>
                                <tbody>
                                    {% for e in employees %}
                                    <tr><td>{{ e.username }}</td><td>{{ e.full_name }}</td><td><button class="btn btn-sm btn-primary edit-emp-btn" data-id="{{ e.id }}" data-user="{{ e.username }}" data-name="{{ e.full_name }}"><i class="fas fa-edit"></i></button><form method="POST" class="d-inline" onsubmit="return confirm('X√≥a nh√¢n vi√™n n√†y?');"><input type="hidden" name="delete_employee" value="1"><input type="hidden" name="user_id" value="{{ e.id }}"><button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></form></td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'discounts' else '' }}" id="tab-discounts">
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow mb-3 border-0">
                        <div class="card-header bg-warning text-dark fw-bold" id="disc-header"><i class="fas fa-tags"></i> Th√™m M√£ Gi·∫£m</div>
                        <div class="card-body">
                            <form method="POST" id="disc-form">
                                <input type="hidden" name="save_discount" value="1">
                                <input type="hidden" name="discount_id" id="disc-id">
                                <div class="mb-2"><label class="fw-bold">M√£ Code:</label><input type="text" name="code" id="disc-code" class="form-control" placeholder="VD: SALE50" required></div>
                                <div class="mb-3"><label class="fw-bold">Gi·∫£m (%):</label><input type="number" name="percent" id="disc-percent" class="form-control" placeholder="10" required></div>
                                <button type="submit" class="btn btn-warning w-100 fw-bold" id="disc-save">L∆ØU M√É</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="resetDiscForm()" id="disc-cancel" style="display:none;">H·ªßy S·ª≠a</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card shadow border-0">
                        <div class="card-body p-0">
                            <table class="table table-bordered mb-0 align-middle">
                                <thead class="table-light"><tr><th>M√£ Code</th><th>Gi·∫£m gi√°</th><th>H√†nh ƒë·ªông</th></tr></thead>
                                <tbody>
                                    {% for d in discounts %}
                                    <tr>
                                        <td class="fw-bold text-primary">{{ d.code }}</td>
                                        <td>{{ d.percentage }}%</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary edit-disc-btn" 
                                                data-id="{{ d.id }}" 
                                                data-code="{{ d.code }}" 
                                                data-percent="{{ d.percentage }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <form method="POST" class="d-inline" onsubmit="return confirm('X√≥a m√£ n√†y?');">
                                                <input type="hidden" name="delete_discount" value="1">
                                                <input type="hidden" name="discount_id" value="{{ d.id }}">
                                                <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-bills">
            <div class="card shadow border-0">
                <div class="card-header bg-dark text-white fw-bold"><i class="fas fa-history"></i> L·ªãch S·ª≠ Giao D·ªãch Chi Ti·∫øt</div>
                <div class="card-body p-0 table-responsive" style="max-height: 600px;">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr><th>M√£ Hƒê</th><th>Th·ªùi gian</th><th>Kh√°ch h√†ng</th><th>Thu ng√¢n</th><th>Chi ti·∫øt m√≥n</th><th>Gi·∫£m gi√°</th><th>Th·ª±c thu</th></tr>
                        </thead>
                        <tbody>
                            {% for bill in all_bills %}
                            <tr>
                                <td>#{{ bill.id }}</td>
                                <td>{{ bill.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
                                <td>{{ bill.order.customer.full_name if bill.order.customer else 'Kh√°ch v√£ng lai' }}</td>
                                <td>{{ bill.order.staff.full_name if bill.order.staff else 'T·ª± ƒë·ªông' }}</td>
                                <td><small>{{ bill.order.details_str }}</small></td>
                                <td class="text-success">{{ "-{:,.0f}".format(bill.discount_applied) }}</td>
                                <td class="fw-bold text-danger">{{ "{:,.0f}".format(bill.final_amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title fw-bold"><i class="fas fa-chart-pie"></i> T·ªîNG QUAN DOANH THU</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><div class="row mb-4 text-center"><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-success text-white rounded"><h6 class="text-uppercase small">H√¥m nay</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_day) }} ƒë</h3></div></div></div><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-primary text-white rounded"><h6 class="text-uppercase small">Tu·∫ßn n√†y</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_week) }} ƒë</h3></div></div></div><div class="col-md-4"><div class="card border-0 shadow-sm"><div class="card-body bg-danger text-white rounded"><h6 class="text-uppercase small">Th√°ng n√†y</h6><h3 class="fw-bold my-2">{{ "{:,.0f}".format(rev_month) }} ƒë</h3></div></div></div></div><hr><h6 class="fw-bold mb-3"><i class="fas fa-filter"></i> Tra c·ª©u chi ti·∫øt:</h6><form method="POST"><input type="hidden" name="filter_report" value="1"><div class="row"><div class="col-md-4 mb-3"><select class="form-select" id="filterType" name="filter_type" onchange="toggleDateInput()"><option value="day">Theo Ng√†y</option><option value="month">Theo Th√°ng</option><option value="year">Theo NƒÉm</option></select></div><div class="col-md-5 mb-3"><input type="date" class="form-control" name="date_val" id="dateInput" required></div><div class="col-md-3"><button class="btn btn-dark w-100 fw-bold">Tra c·ª©u</button></div></div></form>{% if report_title %}<div class="alert alert-info text-center mt-3 mb-0">K·∫øt qu·∫£ <b>{{ report_title }}</b>: <span class="fw-bold fs-4 text-danger">{{ "{:,.0f}".format(filtered_revenue) }} ƒë</span></div>{% endif %}</div></div></div></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- LOGIC S·ª¨A S·∫¢N PH·∫®M ---
        const editBtns = document.querySelectorAll('.edit-btn');
        editBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                document.getElementById('inp-pid').value = data.id;
                document.getElementById('inp-name').value = data.name;
                document.getElementById('inp-price').value = data.price;
                document.getElementById('inp-stock').value = data.stock;
                document.getElementById('inp-cat').value = data.cat;
                document.getElementById('inp-img').value = data.img.startsWith('/static') ? "" : data.img;
                document.getElementById('inp-active').checked = (data.active === 'true');
                const header = document.getElementById('form-header');
                const btnSave = document.getElementById('btn-save');
                header.innerHTML = '<i class="fas fa-edit"></i> C·∫≠p Nh·∫≠t M√≥n'; header.className = 'card-header bg-primary text-white fw-bold';
                btnSave.innerHTML = 'L∆ØU THAY ƒê·ªîI'; btnSave.className = 'btn btn-primary w-100 fw-bold shadow-sm';
                document.getElementById('btn-cancel').style.display = 'block';
            });
        });

        // --- LOGIC S·ª¨A NH√ÇN VI√äN ---
        const editEmpBtns = document.querySelectorAll('.edit-emp-btn');
        editEmpBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                document.getElementById('emp-id').value = data.id;
                document.getElementById('emp-user').value = data.user;
                document.getElementById('emp-user').readOnly = true; 
                document.getElementById('emp-name').value = data.name;
                document.getElementById('emp-pass').placeholder = "ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi";
                document.getElementById('emp-pass').required = false;
                const header = document.getElementById('emp-header');
                const btnSave = document.getElementById('emp-save');
                header.innerHTML = '<i class="fas fa-user-edit"></i> C·∫≠p Nh·∫≠t Nh√¢n Vi√™n'; header.className = 'card-header bg-warning text-dark fw-bold';
                btnSave.innerHTML = 'L∆ØU THAY ƒê·ªîI'; btnSave.className = 'btn btn-warning w-100 fw-bold';
                document.getElementById('emp-cancel').style.display = 'block';
            });
        });

        // --- LOGIC S·ª¨A M√É GI·∫¢M GI√Å (M·ªöI) ---
        const editDiscBtns = document.querySelectorAll('.edit-disc-btn');
        editDiscBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const data = this.dataset;
                document.getElementById('disc-id').value = data.id;
                document.getElementById('disc-code').value = data.code;
                document.getElementById('disc-percent').value = data.percent;

                const header = document.getElementById('disc-header');
                const btnSave = document.getElementById('disc-save');
                header.innerHTML = '<i class="fas fa-edit"></i> C·∫≠p Nh·∫≠t M√£';
                header.className = 'card-header bg-primary text-white fw-bold';
                btnSave.innerHTML = 'L∆ØU THAY ƒê·ªîI';
                btnSave.className = 'btn btn-primary w-100 fw-bold';
                document.getElementById('disc-cancel').style.display = 'block';
            });
        });
    });

    function resetForm() {
        document.getElementById('inp-pid').value = ""; document.getElementById('product-form').reset();
        const header = document.getElementById('form-header'); const btnSave = document.getElementById('btn-save');
        header.innerHTML = '<i class="fas fa-plus-circle"></i> Th√™m M√≥n M·ªõi'; header.className = 'card-header bg-success text-white fw-bold';
        btnSave.innerHTML = 'L∆ØU M√ìN'; btnSave.className = 'btn btn-success w-100 fw-bold shadow-sm';
        document.getElementById('btn-cancel').style.display = 'none';
    }

    function resetEmpForm() {
        document.getElementById('emp-id').value = ""; document.getElementById('emp-form').reset();
        document.getElementById('emp-user').readOnly = false;
        document.getElementById('emp-pass').placeholder = "B·∫Øt bu·ªôc nh·∫≠p"; document.getElementById('emp-pass').required = true;
        const header = document.getElementById('emp-header'); const btnSave = document.getElementById('emp-save');
        header.innerHTML = '<i class="fas fa-user-plus"></i> Th√™m Nh√¢n Vi√™n'; header.className = 'card-header bg-info text-white fw-bold';
        btnSave.innerHTML = 'L∆ØU NH√ÇN VI√äN'; btnSave.className = 'btn btn-info w-100 text-white fw-bold';
        document.getElementById('emp-cancel').style.display = 'none';
    }

    // RESET FORM M√É GI·∫¢M GI√Å (M·ªöI)
    function resetDiscForm() {
        document.getElementById('disc-id').value = ""; document.getElementById('disc-form').reset();
        const header = document.getElementById('disc-header'); const btnSave = document.getElementById('disc-save');
        header.innerHTML = '<i class="fas fa-tags"></i> Th√™m M√£ Gi·∫£m'; header.className = 'card-header bg-warning text-dark fw-bold';
        btnSave.innerHTML = 'L∆ØU M√É'; btnSave.className = 'btn btn-warning w-100 fw-bold';
        document.getElementById('disc-cancel').style.display = 'none';
    }

    function toggleDateInput() {
        let type = document.getElementById('filterType').value;
        let input = document.getElementById('dateInput');
        if(type === 'day') input.type = 'date';
        else if(type === 'month') input.type = 'month';
        else if(type === 'year') { input.type = 'number'; input.placeholder="2026"; }
    }
</script>
{% endblock %}
