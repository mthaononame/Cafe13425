{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary fw-bold m-0"><i class="fas fa-desktop"></i> M√ÄN H√åNH THU NG√ÇN</h2>
    <button class="btn btn-info text-white fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#inventoryModal">
        <i class="fas fa-boxes"></i> Ki·ªÉm Tra Kho
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white fw-bold">
        <i class="fas fa-list-alt"></i> DANH S√ÅCH ƒê∆†N H√ÄNG
    </div>
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr><th>Gi·ªù</th><th>B√†n</th><th>Chi ti·∫øt</th><th>T·ªïng ti·ªÅn</th><th>H√†nh ƒë·ªông</th></tr>
            </thead>
            <tbody id="order-table">
                {% for order in orders %}
                <tr id="order-{{ order.id }}">
                    <td><span class="badge bg-secondary">{{ order.created_at.strftime("%H:%M") }}</span></td>
                    <td class="fw-bold text-primary">B√†n {{ order.customer_id }}</td>
                    <td>{{ order.details_str | safe }}
                        {% if order.discount_percent > 0 %}
                            <br><small class="text-success fw-bold"><i class="fas fa-tag"></i> ƒê√£ gi·∫£m {{ order.discount_percent }}%</small>
                        {% endif %}
                    </td>
                    <td class="fw-bold text-danger fs-5">{{ "{:,.0f}".format(order.final_total) }} ƒë</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary fw-bold me-1" onclick="openPaymentModal({{ order.id }}, {{ order.final_total }}, 'B√†n {{ order.customer_id }}')">
                            <i class="fas fa-qrcode"></i> QR
                        </button>
                        <button class="btn btn-sm btn-success fw-bold" onclick="openConfirmModal({{ order.id }}, {{ order.final_total }})">
                            <i class="fas fa-check-circle"></i> Xong
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">üßæ X√ÅC NH·∫¨N THANH TO√ÅN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <input type="hidden" id="modal-qr-id">
                <h6 class="text-muted text-uppercase" id="modal-qr-table">B√ÄN ???</h6>
                <h1 class="text-danger fw-bold display-4 my-3" id="modal-qr-total">0</h1>
                <p class="text-muted mb-4">ƒê√¢y l√† s·ªë ti·ªÅn kh√°ch c·∫ßn thanh to√°n (ƒê√£ tr·ª´ khuy·∫øn m√£i n·∫øu c√≥)</p>
                
                <button class="btn btn-primary w-100 py-3 fw-bold fs-5 shadow-sm" onclick="sendQrToCustomer()">
                    <i class="fas fa-paper-plane"></i> G·ª¨I M√É QR
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmPayModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white justify-content-center"><h5 class="modal-title fw-bold">X√ÅC NH·∫¨N</h5></div>
            <div class="modal-body text-center p-4">
                <div class="mb-3"><i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i></div>
                <p class="fw-bold mb-1">ƒê√£ nh·∫≠n ƒë·ªß ti·ªÅn?</p>
                <h4 class="text-success fw-bold" id="confirm-amount">0 ƒë</h4>
                <input type="hidden" id="confirm-id">
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4"><button type="button" class="btn btn-light fw-bold px-4" data-bs-dismiss="modal">H·ªßy</button><button type="button" class="btn btn-success fw-bold px-4" onclick="processConfirm()">ƒê·ªíNG √ù</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="inventoryModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">üì¶ T·ªíN KHO</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><table class="table table-striped mb-0"><thead><tr><th>T√™n m√≥n</th><th class="text-end">SL</th></tr></thead><tbody>{% for p in products %}<tr><td>{{ p.name }}</td><td class="text-end fw-bold {{ 'text-danger' if p.inventory.stock_quantity < 10 else 'text-success' }}">{{ p.inventory.stock_quantity }}</td></tr>{% endfor %}</tbody></table></div></div></div></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var socket = io({transports: ['websocket', 'polling']});
        var paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        var confirmPayModal = new bootstrap.Modal(document.getElementById('confirmPayModal'));

        socket.on('update_staff_orders', function(data) {
            let discountBadge = data.discount > 0 ? `<br><small class="text-success fw-bold"><i class="fas fa-tag"></i> ƒê√£ gi·∫£m ${data.discount}%</small>` : '';
            
            let row = `
                <tr id="order-${data.id}" class="table-warning">
                    <td><span class="badge bg-secondary">${data.time}</span></td>
                    <td class="fw-bold text-primary">B√†n ${data.customer}</td>
                    <td>${data.details} ${discountBadge}</td>
                    <td class="fw-bold text-danger fs-5">${parseInt(data.total).toLocaleString()} ƒë</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary fw-bold me-1" onclick="openPaymentModal(${data.id}, ${data.total}, 'B√†n ${data.customer}')">
                            <i class="fas fa-qrcode"></i> QR
                        </button>
                        <button class="btn btn-sm btn-success fw-bold" onclick="openConfirmModal(${data.id}, ${data.total})">
                            <i class="fas fa-check-circle"></i> Xong
                        </button>
                    </td>
                </tr>`;
            document.getElementById('order-table').insertAdjacentHTML('afterbegin', row);
        });

        window.openPaymentModal = function(id, total, tableName) {
            document.getElementById('modal-qr-id').value = id;
            document.getElementById('modal-qr-total').innerText = parseInt(total).toLocaleString() + " ƒë";
            document.getElementById('modal-qr-table').innerText = tableName;
            paymentModal.show();
        }

        window.sendQrToCustomer = function() {
            let id = document.getElementById('modal-qr-id').value;
            // G·ª≠i discount_percent = 0 v√¨ ƒë√£ t√≠nh ·ªü b∆∞·ªõc ƒë·∫∑t h√†ng r·ªìi
            socket.emit('staff_request_payment', { order_id: id, discount_percent: 0 });
            paymentModal.hide();
        }

        window.openConfirmModal = function(id, amount) {
            document.getElementById('confirm-id').value = id;
            document.getElementById('confirm-amount').innerText = parseInt(amount).toLocaleString() + " ƒë";
            confirmPayModal.show();
        }

        window.processConfirm = function() {
            let id = document.getElementById('confirm-id').value;
            socket.emit('staff_confirm_payment', { order_id: id });
            document.getElementById(`order-${id}`).remove();
            confirmPayModal.hide();
        }
    });
</script>
{% endblock %}
