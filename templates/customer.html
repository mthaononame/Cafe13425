{% extends "base.html" %}
{% block content %}
<div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; bg-color:rgba(0,0,0,0.6); z-index:9999; text-align:center; padding-top:20vh;">
    <div class="spinner-border text-light" style="width: 4rem; height: 4rem;"></div><h3 class="text-white mt-3">ƒêang x·ª≠ l√Ω...</h3>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between mb-3"><h3 class="fw-bold text-primary">‚òï MENU</h3><input type="text" id="search-box" class="form-control w-50" placeholder="üîç T√¨m..." onkeyup="filterMenu()"></div>
        <div class="row g-3" id="menu-container">
            {% for p in products %}
            <div class="col-6 col-md-4 product-item" data-name="{{ p.name.lower() }}">
                <div class="card h-100 shadow-sm item-card" data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.price }}" style="cursor: pointer;">
                    <img src="{{ p.image }}" class="card-img-top" style="height:150px; object-fit:contain;" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="card-body text-center p-2"><h6 class="fw-bold">{{ p.name }}</h6><div class="text-danger fw-bold">{{ "{:,.0f}".format(p.price) }} ƒë</div></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow mb-3" id="cart-view">
            <div class="card-header bg-primary text-white fw-bold">üõí GI·ªé H√ÄNG</div>
            <div class="card-body">
                <ul id="cart-list" class="list-group mb-3"><li class="list-group-item text-center text-muted">Tr·ªëng</li></ul>
                
                <div class="input-group mb-3">
                    <input type="text" id="discount-code" class="form-control" placeholder="M√£ gi·∫£m gi√°">
                    <button class="btn btn-outline-secondary" onclick="checkDiscount()">√Åp d·ª•ng</button>
                </div>
                <div id="discount-msg" class="small mb-2 fw-bold"></div>

                <div class="d-flex justify-content-between">
                    <span>T·∫°m t√≠nh:</span><span id="raw-total">0 ƒë</span>
                </div>
                <div class="d-flex justify-content-between text-success">
                    <span>Gi·∫£m gi√°:</span><span id="discount-amt">-0 ƒë</span>
                </div>
                <h4 class="text-danger fw-bold text-end mt-2" id="final-total">0 ƒë</h4>
                
                <button class="btn btn-success w-100 fw-bold py-2 mt-2" onclick="submitOrder()">G·ªåI M√ìN</button>
            </div>
        </div>
        
        <div class="card shadow border-danger" id="qr-view" style="display: none;">
            <div class="card-header bg-danger text-white fw-bold text-center">üßæ H√ìA ƒê∆†N</div>
            <div class="card-body p-3">
                <div class="table-responsive mb-3" style="max-height: 250px;"><table class="table table-sm table-bordered small"><thead class="table-light"><tr><th>M√≥n</th><th>SL</th><th>Ti·ªÅn</th></tr></thead><tbody id="bill-items"></tbody></table></div>
                <div class="border-top pt-2">
                    <div class="d-flex justify-content-between text-muted"><span>T·∫°m t√≠nh:</span><span id="bill-raw"></span></div>
                    <div class="d-flex justify-content-between text-success"><span>Gi·∫£m gi√°:</span><span id="bill-discount"></span></div>
                    <div class="d-flex justify-content-between fw-bold fs-4 text-danger mt-1"><span>T·ªîNG:</span><span id="bill-final"></span></div>
                </div>
                <div class="text-center mt-3 p-2 bg-light rounded border">
                    <p class="mb-1 small fw-bold">QU√âT M√É ƒê·ªÇ THANH TO√ÅN</p>
                    <img id="qr-image" src="" class="img-fluid" style="max-width: 180px;">
                </div>
                <button class="btn btn-secondary btn-sm w-100 mt-3" onclick="location.reload()">Quay l·∫°i Menu</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customizeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modal-p-name">T√πy ch·ªânh</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="modal-p-id"><input type="hidden" id="modal-p-price"><div class="mb-3"><label class="fw-bold">Size:</label><select id="opt-size" class="form-select"><option value="S">S</option><option value="M" selected>M</option><option value="L">L (+5k)</option></select></div><div class="row"><div class="col-6 mb-3"><label class="fw-bold">ƒê∆∞·ªùng:</label><select id="opt-sugar" class="form-select"><option value="100%">100%</option><option value="50%">50%</option><option value="0%">0%</option></select></div><div class="col-6 mb-3"><label class="fw-bold">ƒê√°:</label><select id="opt-ice" class="form-select"><option value="100%">100%</option><option value="50%">50%</option><option value="0%">0%</option></select></div></div><div class="d-grid"><button class="btn btn-primary fw-bold" onclick="confirmAddToCart()">Th√™m v√†o gi·ªè</button></div></div></div></div></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var socket = io({transports: ['websocket', 'polling']});
        let cart = [];
        let currentDiscountPercent = 0; // Bi·∫øn l∆∞u % gi·∫£m gi√° hi·ªán t·∫°i
        var customizeModal = new bootstrap.Modal(document.getElementById('customizeModal'));

        // C√ÅC H√ÄM X·ª¨ L√ù CART & MODAL GI·ªÆ NGUY√äN NH∆Ø C≈®
        document.querySelectorAll('.item-card').forEach(card => {
            card.addEventListener('click', function() {
                document.getElementById('modal-p-id').value = this.dataset.id;
                document.getElementById('modal-p-name').innerText = this.dataset.name;
                document.getElementById('modal-p-price').value = this.dataset.price;
                customizeModal.show();
            });
        });
        window.confirmAddToCart = function() {
            let id = parseInt(document.getElementById('modal-p-id').value);
            let name = document.getElementById('modal-p-name').innerText;
            let price = parseFloat(document.getElementById('modal-p-price').value);
            let size = document.getElementById('opt-size').value;
            if (size === 'L') price += 5000;
            let options = `Size ${size}, ${document.getElementById('opt-sugar').value} ƒê∆∞·ªùng, ${document.getElementById('opt-ice').value} ƒê√°`;
            let item = cart.find(i => i.id === id && i.options === options);
            if(item) item.qty++; else cart.push({id, name, price, qty: 1, options});
            renderCart(); customizeModal.hide();
        }
        window.removeFromCart = function(i) { cart.splice(i, 1); renderCart(); }

        // --- LOGIC M·ªöI: T√çNH TI·ªÄN C√ì GI·∫¢M GI√Å ---
        function renderCart() {
            let list = document.getElementById('cart-list');
            if(!cart.length) { list.innerHTML='<li class="list-group-item text-center text-muted">Tr·ªëng</li>'; updateTotals(0); return;}
            list.innerHTML = cart.map((i,idx)=>`<li class="list-group-item d-flex justify-content-between"><div><b>${i.name}</b><br><small>${i.options}</small></div><div>${i.price.toLocaleString()}ƒë x${i.qty} <button class="btn btn-sm text-danger" onclick="removeFromCart(${idx})">√ó</button></div></li>`).join('');
            
            let total = cart.reduce((s,i)=>s+(i.price*i.qty),0);
            updateTotals(total);
        }

        function updateTotals(rawTotal) {
            let discountAmt = rawTotal * (currentDiscountPercent / 100);
            let finalTotal = rawTotal - discountAmt;

            document.getElementById('raw-total').innerText = rawTotal.toLocaleString() + " ƒë";
            document.getElementById('discount-amt').innerText = "-" + discountAmt.toLocaleString() + " ƒë";
            document.getElementById('final-total').innerText = finalTotal.toLocaleString() + " ƒë";
        }

        // --- LOGIC M·ªöI: KI·ªÇM TRA M√É GI·∫¢M GI√Å ---
        window.checkDiscount = function() {
            let code = document.getElementById('discount-code').value;
            if(!code) return;
            socket.emit('check_discount_code', {code: code});
        }

        socket.on('discount_result', function(data) {
            let msg = document.getElementById('discount-msg');
            if(data.valid) {
                currentDiscountPercent = data.percent;
                msg.className = "small mb-2 fw-bold text-success";
                msg.innerText = `√Åp d·ª•ng m√£ ${data.code}: Gi·∫£m ${data.percent}%`;
                renderCart(); // T√≠nh l·∫°i ti·ªÅn
            } else {
                currentDiscountPercent = 0;
                msg.className = "small mb-2 fw-bold text-danger";
                msg.innerText = data.msg;
                renderCart();
            }
        });

        window.submitOrder = function() {
            if(!cart.length) return showNotify("Gi·ªè h√†ng tr·ªëng!");
            document.getElementById('loading-overlay').style.display = 'block';
            // G·ª≠i k√®m % gi·∫£m gi√°
            socket.emit('new_order_request', {cart: cart, discount_percent: currentDiscountPercent});
        }
        
        // ... (C√°c ph·∫ßn socket nh·∫≠n QR gi·ªØ nguy√™n)
        socket.on('order_success_response', function(data) {
            document.getElementById('loading-overlay').style.display = 'none';
            showNotify(data.msg); cart=[]; currentDiscountPercent=0; renderCart();
            document.getElementById('discount-code').value=""; document.getElementById('discount-msg').innerText="";
        });

        socket.on('show_customer_qr', function(data) {
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('qr-view').style.display = 'block';
            let html = data.items.map(i=>`<tr><td>${i.name}</td><td class="text-center">${i.qty}</td><td class="text-end">${i.subtotal.toLocaleString()}</td></tr>`).join('');
            document.getElementById('bill-items').innerHTML = html;
            document.getElementById('bill-raw').innerText = parseInt(data.raw_total).toLocaleString() + " ƒë";
            document.getElementById('bill-discount').innerText = "-" + parseInt(data.discount).toLocaleString() + " ƒë";
            document.getElementById('bill-final').innerText = parseInt(data.total).toLocaleString() + " ƒë";
            let url = `https://img.vietqr.io/image/MB-123456789-compact2.png?amount=${data.total}&addInfo=ThanhToan`;
            document.getElementById('qr-image').src = url;
        });
        
        socket.on('payment_success', function() {
            showNotify("Thanh to√°n th√†nh c√¥ng!"); setTimeout(()=>location.reload(), 2000);
        });

        window.filterMenu = function() {
            let t = document.getElementById('search-box').value.toLowerCase();
            document.querySelectorAll('.product-item').forEach(i => i.style.display = i.dataset.name.includes(t)?'block':'none');
        }
    });
</script>
{% endblock %}
